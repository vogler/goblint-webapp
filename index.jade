doctype 5
html(ng-app="goblint")
  head
    title(ng-bind-template="{{title}} - goblint")
    link(href="components/bootstrap/dist/css/bootstrap.min.css", rel="stylesheet", media="screen")
    link(href="components/angular-ui/build/angular-ui.min.css", rel="stylesheet")
    link(href="components/codemirror/lib/codemirror.css", rel="stylesheet")
    //- link(href="components/codemirror/theme/monokai.css", rel="stylesheet")
    != css('index')
    script(src="components/jquery/jquery.min.js")
    script(src="components/bootstrap/dist/js/bootstrap.min.js")
    script(src="components/angular/angular.min.js")
    script(src="components/angular-resource/angular-resource.js")
    //- script(src="components/angular-cookies/angular-cookies.js")
    script(src="components/angular-ui/build/angular-ui.min.js")
    script(src="components/codemirror/lib/codemirror.js")
    script(src="components/codemirror/mode/clike/clike.js")
    script(src="components/codemirror/addon/edit/matchbrackets.js")
    script(src="components/codemirror/addon/edit/closebrackets.js")
    script(src="components/codemirror/addon/search/searchcursor.js")
    script(src="components/codemirror/addon/search/match-highlighter.js")
    style
      .CodeMirror-focused .cm-matchhighlight {
        background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAFklEQVQI12NgYGBgkKzc8x9CMDAwAAAmhwSbidEoSQAAAABJRU5ErkJggg==);
        background-position: bottom;
        background-repeat: repeat-x;
      }
    script(src="components/codemirror/addon/display/placeholder.js")
    script(src="components/socket.io-client/dist/socket.io.min.js")
    script
      'use strict';

      var app = angular.module('goblint', ['ngResource', 'ui']);
      app.config(function ($routeProvider, $locationProvider) {
          $routeProvider
            .when('/', {})
            .when('/file/:file', {}) // only used if a ng-view exists :(
            .otherwise({
              redirectTo: '/'
            });
            //- $locationProvider.html5Mode(true); // html5 pushState
        })
        .value('ui.config', {
          jq: {tooltip: {placement: 'right'}}
        });

      console.log("angular-ui ok");

      function SourceCtrl($scope, $location, $routeParams){
        $scope.files = [];
        $scope.refresh = function(){
          $.get('/files', {}, function(files){
            $scope.files = files;
            $scope.$apply();
          });
        };
        $scope.refresh();

        var socket = io.connect('http://localhost');
        socket.on('files', function(files){
          console.log('socket.io: files updated');
          $scope.refresh();
        });

        $scope.newFile = function(text){
          if(!text) text = "";
          editor.setValue(text);
          editor.clearHistory();
          editor.markClean();
          valueChanged();
        };
        $scope.loadFile = function(f){
          $.get('/source/'+f, {}, function(data){
            $scope.newFile(data);
            console.log("loaded file", f);
            $.get('/result/'+f, {}, function(data){
              $('#result').text(data);
            });
          })
          .fail(function(){
            console.log('/source/'+f, 'failed');
            alert("The file "+$routeParams.file+" doesn't exist! Redirecting...");
            if(history.length > 1){
              history.back();
            }else{
              $location.path("/");
              $scope.$apply();
            }
          });
        };
        // gets called on every route change :(
        // alternative would be to add a route with a controller and a templateUrl pointing to a dummy file
        $scope.$on('$routeChangeSuccess', function(ev){
          //- console.log($location, $routeParams);
          if($routeParams.file){
            $scope.loadFile($routeParams.file);
            selectFile($routeParams.file);
            $scope.$parent.title = $routeParams.file;
          }else{
            $scope.newFile();
            selectFile(false); // deselect
            $scope.$parent.title = "";
          }
        });
        $scope.$on('$locationChangeStart', function(ev){
          if(!editor.isClean()){
            if(!confirm("You have unsaved changes! Discard them?"))
              ev.preventDefault(); // stopPropagation
          }
        });

        $scope.saveFile = function(){
          var file = $routeParams.file;
          var isNew = false;
          if(!file){
            file = prompt("New filename:");
            if(!file) return;
            isNew = true;
          }
          $.post('/source/'+file, {value: editor.getValue()}, function(){
            editor.markClean();
            valueChanged();
            console.log("saved file", file);
            if(isNew){
              $location.path("/file/"+file);
              $scope.refresh();
            }
          });
        };
        $scope.renameFile = function(){
          if(!editor.isClean()){
            alert("File is dirty, safe first!");
            return;
          }
          var name = prompt("New filename:");
          if(!name) return;
          $.post('/source/'+$routeParams.file, {name: name}, function(){
            console.log("renamed file", $routeParams.file, "to", name);
            $location.path("/file/"+name);
            $scope.refresh();
          });
        };
        $scope.deleteFile = function(){
          if(!confirm("Delete the file?")) return;
          $.ajax({url: '/source/'+$routeParams.file,
            type: 'DELETE',
            success: function(){
              $location.path("/");
              $scope.refresh();
            }
          });
        };
      }

      function selectFile(file){
        $('#files a').removeClass('active');
        if(file) $("#files a:contains('"+file+"')").toggleClass('active');
      }

      function selectTheme() {
        var theme = $("#theme").val();
        var file = theme.split(' ')[0]+'.css';
        if(theme!="default" && !$("head link[rel='stylesheet'][href*='"+file+"']").length) // no default.css && file not added yet
          $(document.head).append($("<link/>").attr({rel: "stylesheet", href: "components/codemirror/theme/"+file}));
        editor.setOption("theme", theme);
      }

      function valueChanged(){
        $('#file-clean').toggle(editor.isClean());
        $('#file-dirty').toggle(!editor.isClean());
      }

  body
    include ie.fail.html
    .container(ng-controller="SourceCtrl")
      .row
        .col-md-3
          a.btn.btn-default.btn-sm.btn-block(href="#/")
            i.glyphicon.glyphicon-plus
            |  empty file
          div#files.list-group
            a.list-group-item(ng-repeat="file in files", href="#/file/{{file}}") {{file}}
        .col-md-9
          .btn-toolbar
            .btn-group
              a.btn.btn-default(title="save", ui-jq="tooltip", ng-click="saveFile()"): i.glyphicon.glyphicon-floppy-disk
              a.btn.btn-default(title="rename", ui-jq="tooltip", ng-click="renameFile()"): i.glyphicon.glyphicon-pencil
              a.btn.btn-default(title="delete", ui-jq="tooltip", ng-click="deleteFile()"): i.glyphicon.glyphicon-trash
            .btn-group
              span#file-clean.label.label-success
                i.glyphicon.glyphicon-check.icon-white
                |  file clean
              span#file-dirty.label.label-warning
                i.glyphicon.glyphicon-edit.icon-white
                |  file dirty
            .btn-group.form-inline.pull-right
              label(for="theme") Theme:
              select#theme(onchange="selectTheme()")
                option default
                option ambiance
                option blackboard
                option cobalt
                option eclipse
                option elegant
                option erlang-dark
                option lesser-dark
                option midnight
                option monokai
                option neat
                option night
                option rubyblue
                option solarized dark
                option solarized light
                option twilight
                option vibrant-ink
                option xq-dark
                option xq-light
          textarea#source(placeholder="Write new code here or select a file on the left...")
          script
            var editor = CodeMirror.fromTextArea(document.getElementById('source'), {
              mode: 'text/x-csrc', lineNumbers: true, matchBrackets: true, autoCloseBrackets: true, highlightSelectionMatches: true, theme: 'default'
            });
            editor.on('change', function(){
              //- console.log("content changed, clean:", editor.isClean());
              valueChanged();
            });
          div
            span.label.label-success
              i.glyphicon.glyphicon-ok.icon-white
              |  no warnings
            span.label.label-warning
              i.glyphicon.glyphicon-warning-sign.icon-white
              |  3 warnings
          textarea#result
          div(ng-view)
    if node_env=="development"
      // livereload snippet
      script
        document.write('<script src="http://'
         + (location.host || 'localhost').split(':')[0]
         + ':35729/livereload.js?snipver=1"><\/script>')
